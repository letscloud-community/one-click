#!/bin/bash

set -euo pipefail
exec > >(tee /var/log/nixopus-onboot.log) 2>&1

echo "[onboot] Waiting for cloud-init to finish..."
cloud-init status --wait

if [ -d /etc/update-motd.d ] && [ -f /etc/update-motd.d/99-startup ]; then
  echo "[onboot] Ensuring MOTD script is executable..."
  chmod +x /etc/update-motd.d/99-startup
fi

echo "[onboot] Ensuring Docker service is running..."
systemctl enable --now docker || true
sleep 3

echo "[onboot] Installing Nixopus using official installer..."
INSTALL_LOG="/var/log/nixopus/install.log"
mkdir -p "$(dirname "${INSTALL_LOG}")"
: > "${INSTALL_LOG}"

PUBLIC_IP="$(curl -fsSL https://ifconfig.me 2>/dev/null || curl -fsSL https://api.ipify.org 2>/dev/null || hostname -I | awk '{print $1}')"
NIXOPUS_ARGS=(
  "--force"
  "--timeout" "900"
  "--api-port" "8443"
  "--view-port" "7443"
)

if [ -n "${PUBLIC_IP:-}" ]; then
  NIXOPUS_ARGS+=("--host-ip" "${PUBLIC_IP}")
fi

attempt=1
max_attempts=3
until curl -sSL https://install.nixopus.com | bash -s -- "${NIXOPUS_ARGS[@]}" 2>&1 | tee -a "${INSTALL_LOG}"; do
  if [ "$attempt" -ge "$max_attempts" ]; then
    echo "[onboot] ERROR: Nixopus installation failed after ${max_attempts} attempts. Check ${INSTALL_LOG}."
    break
  fi
  attempt=$((attempt + 1))
  echo "[onboot] WARN: Retrying Nixopus installation (attempt ${attempt}/${max_attempts}) in 15s..."
  sleep 15
done

if command -v nixopus >/dev/null 2>&1; then
  echo "[onboot] Installed Nixopus version: $(nixopus --version 2>/dev/null || echo 'unknown')"
else
  echo "[onboot] WARNING: The 'nixopus' binary was not found after installation."
fi

echo "[onboot] Removing temporary SSH ForceCommand guard..."
sed -e '/Match User root/d' \
    -e '/.*ForceCommand.*instance.*/d' \
    -i /etc/ssh/sshd_config

systemctl restart ssh || systemctl restart sshd

echo "[onboot] Ensuring Docker and Nixopus services are up..."
systemctl enable --now docker || true
if systemctl list-unit-files | grep -q '^nixopus'; then
  systemctl enable --now nixopus || true
fi

echo "[onboot] Cleanup complete. Removing this script so it only runs once."
rm -f /var/lib/cloud/scripts/per-instance/001_onboot

